<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CFD Planning Request Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    :root{
      --cfd-red: #d62828;        /* primary red */
      --cfd-red-dark:#b41f1f;    /* hover red */
      --cfd-black:#111111;       /* deep black */
      --cfd-gray:#f5f6f7;        /* page bg */
      --cfd-border:#e6e6e6;
      --pill-gray:#f0f0f0;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; padding:0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--cfd-gray);
      color:#222;
      display:flex; justify-content:center; align-items:center;
      min-height:100vh;
    }
    .shell{
      width: min(980px, 96vw);
      background:#fff;
      border-radius:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
      overflow:hidden;
      border:1px solid var(--cfd-border);
    }
    /* Header */
    .header{
      display:flex; align-items:center; gap:16px;
      background: var(--cfd-black);
      color:#fff;
      padding:16px 20px;
      border-bottom:4px solid var(--cfd-red);
    }
    .header img{
      width:48px; height:48px; object-fit:contain;
      background:#fff; border-radius:8px; padding:6px;
      border:1px solid #fff;
    }
    .header-title{
      line-height:1.2;
    }
    .header-title h1{
      font-size:20px; margin:0 0 2px 0; font-weight:700;
      letter-spacing:.3px;
    }
    .header-title span{
      font-size:12px; opacity:.85;
    }

    /* Layout */
    .content{
      display:grid; grid-template-columns: 1fr 340px;
      gap:16px; padding:16px;
    }
    @media (max-width: 860px){
      .content{ grid-template-columns: 1fr; }
    }

    /* Chat panel */
    .panel{
      background:#fff; border:1px solid var(--cfd-border);
      border-radius:12px; overflow:hidden;
    }
    .panel-header{
      background:#fff; padding:12px 16px; border-bottom:1px solid var(--cfd-border);
      display:flex; align-items:center; justify-content:space-between;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      background: var(--pill-gray); color:#333;
      padding:6px 10px; border-radius:999px; font-size:12px; font-weight:600;
    }
    .dot{ width:8px; height:8px; background: var(--cfd-red); border-radius:50%; display:inline-block; }
    #chat-box{
      height: 460px; overflow-y:auto; padding:16px;
      background:#fff;
    }
    .message{ margin:10px 0; max-width:88%; }
    .bubble{
      padding:10px 14px; border-radius:12px; line-height:1.45; font-size:14px;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
      border:1px solid var(--cfd-border);
    }
    .user .bubble{
      background:#fff8f8; border-color:#ffd9d9;
      color:#3a0e0e;
      margin-left:auto;
    }
    .ai .bubble{
      background:#fafafa; color:#1f1f1f;
    }
    .meta{
      font-size:11px; opacity:.65; margin-top:4px;
    }

    /* Input row */
    .input-row{
      display:flex; gap:10px; padding:12px; border-top:1px solid var(--cfd-border);
      background:#fff;
    }
    .input-row input[type="text"]{
      flex:1; padding:12px 14px; border-radius:10px; border:1px solid var(--cfd-border);
      font-size:14px; outline:none;
    }
    .btn{
      border:none; border-radius:10px; padding:12px 16px; font-weight:700;
      cursor:pointer; transition: all .15s ease;
    }
    .btn-send{ background: var(--cfd-red); color:#fff; }
    .btn-send:hover{ background: var(--cfd-red-dark); }

    /* Side form / confirmation */
    .side{
      display:flex; flex-direction:column; gap:12px;
    }
    .card{
      background:#fff; border:1px solid var(--cfd-border); border-radius:12px; overflow:hidden;
    }
    .card-head{
      padding:12px 14px; border-bottom:1px solid var(--cfd-border);
      font-weight:700; font-size:14px; background:#fff;
    }
    .card-body{ padding:14px; }

    #final-preview{
      display:none;
      background:#fff5f5; border:1px dashed var(--cfd-red); color:#2a0b0b;
      border-radius:10px; padding:12px; font-size:14px; white-space:pre-line;
    }

    .form-row{ display:flex; flex-direction:column; gap:8px; margin-top:10px; }
    .form-row input[type="email"]{
      padding:10px 12px; border:1px solid var(--cfd-border); border-radius:8px; font-size:14px;
    }
    .actions{ display:flex; gap:8px; margin-top:10px; }
    .btn-confirm{ background: var(--cfd-red); color:#fff; }
    .btn-confirm:hover{ background: var(--cfd-red-dark); }
    .btn-reset{ background:#222; color:#fff; }
    .btn-reset:hover{ filter: brightness(1.1); }

    /* Footer ribbon */
    .ribbon{
      padding:10px 16px; text-align:center; font-size:12px; color:#666;
      border-top:1px solid var(--cfd-border); background:#fff;
    }
    .strong{ font-weight:700; color:var(--cfd-black); }
  </style>
</head>
<body>
  <div class="shell">
    <div class="header">
      <img src="{{ url_for('static', filename='cfd.jpg') }}" alt="CFD Logo" />
      <div class="header-title">
        <h1>Charlotte Fire Department ‚Äî Planning</h1>
        <span>Request Intake Prototype</span>
      </div>
    </div>

    <div class="content">
      <!-- Chat Panel -->
      <div class="panel">
        <div class="panel-header">
          <div class="badge"><span class="dot"></span> Live Intake</div>
          <div style="font-size:12px; opacity:.75;">Red ‚Ä¢ Black ‚Ä¢ White</div>
        </div>

        <div id="chat-box"></div>

        <div class="input-row">
          <input id="message" type="text" placeholder="Type your request (e.g., 'Need Q2 travel spending for Training Division')..." />
          <button id="send" class="btn btn-send">Send</button>
        </div>
      </div>

      <!-- Side: Finalize & Submit -->
      <div class="side">
        <div class="card">
          <div class="card-head">Finalized Request Preview</div>
          <div class="card-body">
            <div id="final-preview"></div>
          </div>
        </div>

        <form id="submit-form" class="card" action="/submit" method="POST" style="display:none;">
          <div class="card-head">Confirm & Submit</div>
          <div class="card-body">
            <!-- Hidden if you ever want to pass it; backend rebuilds anyway -->
            <input type="hidden" name="final_request" id="final_request" />
            <div class="form-row">
              <label for="email" class="strong">Your Email</label>
              <input id="email" name="email" type="email" placeholder="you@charlottenc.gov" required />
            </div>
            <div class="actions">
              <button type="submit" class="btn btn-confirm">‚úÖ Confirm & Submit</button>
              <button type="button" id="reset" class="btn btn-reset">üóë Clear Chat</button>
            </div>
          </div>
        </form>

        <div class="card">
          <div class="card-head">Tips</div>
          <div class="card-body" style="font-size:13px; color:#444;">
            ‚Ä¢ Keep it simple: WHO/WHAT ‚Ä¢ METRICS ‚Ä¢ TIME RANGE ‚Ä¢ OUTPUT (optional).<br/>
            ‚Ä¢ Example: ‚ÄúStation 22 ‚Ä¢ total calls + avg response time ‚Ä¢ 2024 ‚Ä¢ CSV‚Äù.
          </div>
        </div>
      </div>
    </div>

    <div class="ribbon">
      Prototype for internal CFD Planning workflows. Questions? Contact <span class="strong">Planning Division</span>.
    </div>
  </div>

  <script>
    function appendMessage(sender, text, role){
      const wrap = document.createElement("div");
      wrap.className = "message " + (role === "user" ? "user" : "ai");
      wrap.innerHTML = `
        <div class="bubble"><strong>${sender}:</strong> ${text}</div>
      `;
      document.getElementById("chat-box").appendChild(wrap);
      const box = document.getElementById("chat-box");
      box.scrollTop = box.scrollHeight;
    }

    function showPreviewIfPresent(reply){
      const lower = reply.toLowerCase();
      // Show when finalization or explicit confirm cue appears
      if (lower.includes("here‚Äôs your finalized request") ||
          lower.includes("please click confirm & submit")) {

        // Try to extract the bold ** ... ** content
        const match = reply.match(/\*\*(.*?)\*\*/s);
        const finalRequest = match ? match[1].trim() : "";

        // Display preview
        const preview = document.getElementById("final-preview");
        if (finalRequest){
          preview.textContent = finalRequest;
          document.getElementById("final_request").value = finalRequest; // optional
        } else {
          // fallback to entire reply if not bolded
          preview.textContent = reply;
          document.getElementById("final_request").value = reply; // optional
        }
        preview.style.display = "block";
        document.getElementById("submit-form").style.display = "block";
      }
    }

    function sendMessage(){
      const input = document.getElementById("message");
      const msg = input.value.trim();
      if(!msg) return;
      appendMessage("You", msg, "user");

      $.ajax({
        url: "/chat",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({ message: msg }),
        success: function(data){
          appendMessage("AI", data.reply, "ai");
          showPreviewIfPresent(data.reply);
        },
        error: function(){
          appendMessage("AI", "Sorry, something went wrong. Please try again.", "ai");
        }
      });

      input.value = "";
    }

    $("#send").on("click", sendMessage);
    $("#message").on("keypress", function(e){
      if(e.which === 13){ sendMessage(); return false; }
    });

    $("#reset").on("click", function(){
      $.post("/reset", {}, function(data){
        appendMessage("AI", data.reply, "ai");
        $("#final-preview").hide().text("");
        $("#submit-form").hide();
      });
    });
  </script>
</body>
</html>
